<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MONEY TALKS — Penalty Shootout</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&display=swap');

    :root {
      --bg: #020617;
      --card: rgba(15, 23, 42, 0.96);
      --border: rgba(148, 163, 184, 0.4);
      --accent1: #38bdf8;
      --accent2: #6366f1;
      --danger: #f97373;
      --success: #4ade80;
      --gold1: #fde047;
      --gold2: #facc15;
      --gold3: #fef9c3;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #e5e7eb;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(56,189,248,0.10) 0, transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(129,140,248,0.10) 0, transparent 55%),
        radial-gradient(circle at 50% 80%, rgba(251,146,60,0.12) 0, transparent 55%);
      opacity: 0.8;
      pointer-events: none;
    }

    .back-btn {
      position: fixed;
      top: 12px;
      left: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      z-index: 20;
    }
    .back-btn:hover {
      border-color: var(--accent1);
    }

    .app-wrap {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 520px;
      padding: 16px;
    }

    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px 18px 22px;
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      border-radius: 22px;
      border: 1px solid var(--border);
      box-shadow:
        0 22px 50px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.7);
      text-align: center;
    }
    .screen.active { display: flex; }

    .card-title {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .18em;
      text-transform: uppercase;
      background: linear-gradient(110deg, #e5e7eb, #f97316);
      -webkit-background-clip: text;
      color: transparent;
    }

    .sub {
      font-size: 12px;
      opacity: .75;
    }

    .field-wrap {
      width: 100%;
      margin-top: 6px;
    }
    .label {
      font-size: 12px;
      text-align: left;
      opacity: .7;
      margin-bottom: 4px;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .input-row input {
      flex: 1;
      padding: 11px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }
    .input-row input:focus {
      border-color: var(--accent1);
    }
    .indicator {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .indicator.ok {
      border-color: var(--success);
      color: var(--success);
    }
    .indicator.err {
      border-color: var(--danger);
      color: var(--danger);
    }
    .msg {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
      margin-top: 4px;
    }

    .btn {
      margin-top: 12px;
      padding: 11px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      background: linear-gradient(110deg, #38bdf8, #6366f1);
      color: #020617;
      box-shadow: 0 12px 30px rgba(56,189,248,0.45);
      transition: transform .15s ease, box-shadow .15s ease, opacity .15s;
    }
    .btn:active {
      transform: translateY(1px) scale(.98);
      box-shadow: 0 8px 18px rgba(56,189,248,0.35);
    }
    .btn:disabled {
      opacity: .5;
      cursor: default;
      box-shadow: none;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      border: 5px solid rgba(148,163,184,0.35);
      border-top-color: var(--accent1);
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .best-label { font-size: 12px; opacity: .75; }
    .best-value {
      margin-top: 2px;
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(110deg, var(--gold1), var(--gold2), var(--gold3));
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 0 0 18px rgba(234,179,8,0.55);
    }
    .attempts {
      margin-top: 4px;
      font-size: 12px;
      opacity: .8;
    }

    /* PENALTY FIELD */
    .goal-wrap {
      width: 100%;
      margin-top: 14px;
      border-radius: 18px;
      padding: 10px;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617 100%);
      border: 1px solid rgba(59,130,246,0.7);
      box-shadow: 0 0 32px rgba(56,189,248,0.3);
    }
    .goal {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 14px;
      border: 2px solid rgba(248,250,252,0.8);
      background:
        radial-gradient(circle at top, rgba(59,130,246,0.18), transparent 60%),
        repeating-linear-gradient(0deg, rgba(148,163,184,0.3) 0 2px, transparent 2px 10px),
        repeating-linear-gradient(90deg, rgba(148,163,184,0.3) 0 2px, transparent 2px 10px),
        #020617;
      overflow: hidden;
    }

    .keeper {
      position: absolute;
      left: 50%;
      bottom: 10%;
      transform: translateX(-50%);
      width: 16%;
      height: 28%;
      border-radius: 10px;
      background: linear-gradient(145deg, #f97316, #ec4899);
      box-shadow: 0 0 16px rgba(248,113,113,0.9);
    }
    .keeper::before {
      content: "";
      position: absolute;
      inset: -16% 20% auto 20%;
      height: 30%;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #fee2e2, #b91c1c);
    }

    .spot {
      position: absolute;
      width: 16%;
      aspect-ratio: 1/1;
      border-radius: 999px;
      border: 2px solid rgba(248,250,252,0.7);
      box-shadow: 0 0 10px rgba(148,163,184,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: .25;
      transform: translate(-50%, -50%);
      transition: opacity .12s ease, box-shadow .12s ease, transform .12s ease;
    }
    .spot::before {
      content: "";
      width: 65%;
      height: 65%;
      border-radius: 999px;
      border: 2px solid rgba(248,250,252,0.7);
    }
    .spot.scan {
      opacity: .55;
      box-shadow: 0 0 16px rgba(96,165,250,0.9);
    }
    .spot.active {
      opacity: 1;
      box-shadow: 0 0 24px rgba(250,204,21,1);
      transform: translate(-50%, -50%) scale(1.1);
      background: radial-gradient(circle at 30% 10%, #fef9c3, #facc15);
    }

    /* positions: 6 зон ворот */
    .spot.tl { left: 18%; top: 25%; }
    .spot.tc { left: 50%; top: 20%; }
    .spot.tr { left: 82%; top: 25%; }
    .spot.bl { left: 20%; top: 70%; }
    .spot.bc { left: 50%; top: 68%; }
    .spot.br { left: 80%; top: 70%; }

    .hint-bottom {
      margin-top: 6px;
      font-size: 11px;
      opacity: .7;
    }
  </style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='../index.html'">← <span>MONEY TALKS</span></button>

<div class="app-wrap">

  <!-- PROMO -->
  <section id="promoScreen" class="screen active">
    <div class="card-title">PENALTY ACCESS</div>
    <div class="sub">Enter one-time promo code for Penalty Shootout</div>

    <div class="field-wrap">
      <div class="label">Promo code</div>
      <div class="input-row">
        <input id="promoInput" placeholder="EXAMPLE88" maxlength="16" />
        <div id="promoIndicator" class="indicator">?</div>
      </div>
      <div id="promoMsg" class="msg"></div>
    </div>

    <button id="promoBtn" class="btn">Check promo</button>
  </section>

  <!-- LINK -->
  <section id="linkScreen" class="screen">
    <div class="card-title">CASINO LINK</div>
    <div class="sub">Paste Penalty Shootout URL from your casino</div>

    <div class="field-wrap">
      <div class="label">Game link</div>
      <div class="input-row">
        <input id="linkInput" placeholder="https://example.com/game/penalty" />
        <div id="linkIndicator" class="indicator">?</div>
      </div>
      <div id="linkMsg" class="msg"></div>
    </div>

    <button id="linkBtn" class="btn">Connect</button>
  </section>

  <!-- CONNECTION -->
  <section id="connectScreen" class="screen">
    <div class="spinner"></div>
    <div class="sub" style="text-transform:uppercase; letter-spacing:.18em;">Connecting...</div>
  </section>

  <!-- GAME -->
  <section id="gameScreen" class="screen">
    <div class="card-title">PENALTY ANALYZER</div>
    <div class="sub">Simulated prediction. No real bets.</div>

    <div class="best-label">Prediction result</div>
    <div id="bestValue" class="best-value">x0.00</div>
    <div id="attemptsText" class="attempts">Attempts left: 7</div>

    <div class="goal-wrap">
      <div class="goal">
        <div class="keeper"></div>

        <div class="spot tl" data-i="0"></div>
        <div class="spot tc" data-i="1"></div>
        <div class="spot tr" data-i="2"></div>
        <div class="spot bl" data-i="3"></div>
        <div class="spot bc" data-i="4"></div>
        <div class="spot br" data-i="5"></div>
      </div>
    </div>

    <button id="signalBtn" class="btn">Get signal</button>
    <div class="hint-bottom">Each promo code has 7 predictions for Penalty Shootout.</div>
  </section>

</div>

<script>
const API_BASE = "/api";
const GAME_ID  = "footballx";   // промо и лимиты остаются как у FootballX

let attemptsLeft = 0;
let currentPromo = null;
let isBusy = false;
let bestMult = 0;

// экраны
const promoScreen   = document.getElementById("promoScreen");
const linkScreen    = document.getElementById("linkScreen");
const connectScreen = document.getElementById("connectScreen");
const gameScreen    = document.getElementById("gameScreen");

function showScreen(screen) {
  [promoScreen, linkScreen, connectScreen, gameScreen]
    .forEach(s => s.classList.remove("active"));
  screen.classList.add("active");
}

/* ---------- PROMO ---------- */

const promoInput     = document.getElementById("promoInput");
const promoIndicator = document.getElementById("promoIndicator");
const promoMsg       = document.getElementById("promoMsg");
const promoBtn       = document.getElementById("promoBtn");

promoInput.addEventListener("input", () => {
  promoIndicator.className = "indicator";
  promoIndicator.textContent = "?";
  promoMsg.textContent = "";
});

promoBtn.onclick = async () => {
  const code = promoInput.value.trim().toUpperCase();
  if (!code) {
    promoMsg.textContent = "Enter promo code";
    promoIndicator.className = "indicator err";
    promoIndicator.textContent = "✕";
    return;
  }

  promoBtn.disabled = true;
  promoIndicator.className = "indicator";
  promoIndicator.textContent = "…";
  promoMsg.textContent = "";

  try {
    const res = await fetch(`${API_BASE}/promo/check`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ game: GAME_ID, code })
    });

    const data = await res.json();

    if (!data.valid) {
      promoIndicator.className = "indicator err";
      promoIndicator.textContent = "✕";
      promoMsg.textContent = "Promo invalid or exhausted.";
      promoBtn.disabled = false;
      return;
    }

    attemptsLeft = data.attempts_left;
    currentPromo = code;

    promoIndicator.className = "indicator ok";
    promoIndicator.textContent = "✓";
    promoMsg.textContent = "";

    setTimeout(() => showScreen(linkScreen), 250);
  } catch (e) {
    console.error(e);
    promoIndicator.className = "indicator err";
    promoIndicator.textContent = "!";
    promoMsg.textContent = "Connection error.";
  } finally {
    promoBtn.disabled = false;
  }
};

/* ---------- LINK ---------- */

const linkInput     = document.getElementById("linkInput");
const linkIndicator = document.getElementById("linkIndicator");
const linkMsg       = document.getElementById("linkMsg");
const linkBtn       = document.getElementById("linkBtn");

linkInput.addEventListener("input", () => {
  linkIndicator.className = "indicator";
  linkIndicator.textContent = "?";
  linkMsg.textContent = "";
});

function isValidUrl(u) {
  return /^https?:\/\/[\w\-_.]+/i.test(u);
}

linkBtn.onclick = () => {
  const url = linkInput.value.trim();
  if (!isValidUrl(url)) {
    linkIndicator.className = "indicator err";
    linkIndicator.textContent = "✕";
    linkMsg.textContent = "Invalid URL.";
    return;
  }

  linkIndicator.className = "indicator ok";
  linkIndicator.textContent = "✓";
  linkMsg.textContent = "";

  showScreen(connectScreen);

  setTimeout(() => {
    updateAttemptsText();
    showScreen(gameScreen);
  }, 2000 + Math.random() * 800);
};

/* ---------- GAME LOGIC ---------- */

const attemptsEl = document.getElementById("attemptsText");
const bestEl     = document.getElementById("bestValue");
const signalBtn  = document.getElementById("signalBtn");
const spots      = Array.from(document.querySelectorAll(".spot"));

// коэффициенты для каждой зоны (как в слоте, более реалистичные)
const SPOT_MULTS = [1.30, 1.80, 3.40, 2.10, 4.80, 8.50];

// веса для выбора (центр почаще, углы реже)
const SPOT_WEIGHTS = [1.0, 1.4, 1.1, 1.1, 1.3, 0.7];

function updateAttemptsText() {
  attemptsEl.textContent = "Attempts left: " + attemptsLeft;
}

async function useAttemptOnServer() {
  if (!currentPromo) throw new Error("no_promo");

  const res = await fetch(`${API_BASE}/game/use`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ game: GAME_ID, code: currentPromo })
  });

  if (!res.ok) {
    const data = await res.json().catch(() => ({}));
    if (data.detail === "limit_exceeded") {
      attemptsLeft = 0;
      updateAttemptsText();
      throw new Error("limit");
    }
    throw new Error("server");
  }

  const data = await res.json();
  attemptsLeft = data.remaining;
}

function weightedRandomIndex(weights) {
  const sum = weights.reduce((a, b) => a + b, 0);
  let r = Math.random() * sum;
  for (let i = 0; i < weights.length; i++) {
    if (r < weights[i]) return i;
    r -= weights[i];
  }
  return weights.length - 1;
}

function clearSpots() {
  spots.forEach(s => {
    s.classList.remove("scan", "active");
  });
}

function playScanAnimation(finalIndex) {
  return new Promise(resolve => {
    clearSpots();
    let i = 0;
    const order = [0,1,2,5,4,3,2,4,1,3]; // немного хаотично

    const interval = setInterval(() => {
      clearSpots();
      const idx = order[i % order.length];
      spots[idx].classList.add("scan");
      i++;

      if (i > order.length + 4) {
        clearInterval(interval);
        clearSpots();
        spots[finalIndex].classList.add("active");
        resolve();
      }
    }, 90);
  });
}

signalBtn.onclick = async () => {
  if (isBusy) return;
  if (!currentPromo) {
    alert("Promo is required.");
    showScreen(promoScreen);
    return;
  }
  if (attemptsLeft <= 0) {
    alert("No attempts left for this promo.");
    showScreen(promoScreen);
    return;
  }

  isBusy = true;
  signalBtn.disabled = true;

  try {
    await useAttemptOnServer();
  } catch (e) {
    if (e.message === "limit") {
      alert("All attempts are used for this promo.");
      showScreen(promoScreen);
    } else {
      alert("Server error. Try again later.");
    }
    isBusy = false;
    signalBtn.disabled = false;
    return;
  }

  updateAttemptsText();

  const spotIndex = weightedRandomIndex(SPOT_WEIGHTS);
  const mult = SPOT_MULTS[spotIndex];

  await playScanAnimation(spotIndex);

  if (mult > bestMult) bestMult = mult;
  bestEl.textContent = "x" + bestMult.toFixed(2);

  isBusy = false;
  signalBtn.disabled = false;
};
</script>

</body>
</html>