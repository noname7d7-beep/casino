<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MONEY TALKS — Plinko</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&display=swap');

:root {
  --bg: #020617;
  --card: rgba(15, 23, 42, 0.96);
  --border: rgba(148, 163, 184, 0.4);
  --accent1: #38bdf8;
  --accent2: #6366f1;
  --danger: #f97373;
  --success: #4ade80;
  --gold1: #fde047;
  --gold2: #facc15;
  --gold3: #fef9c3;
}

* { box-sizing: border-box; }
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}
body {
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: #e5e7eb;
  background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #020617 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* лёгкий фон */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image:
    radial-gradient(circle at 10% 20%, rgba(56,189,248,0.08) 0, transparent 45%),
    radial-gradient(circle at 80% 10%, rgba(129,140,248,0.07) 0, transparent 55%),
    radial-gradient(circle at 50% 80%, rgba(251,146,60,0.08) 0, transparent 55%);
  opacity: 0.7;
  pointer-events: none;
}

/* назад */
.back-btn {
  position: fixed;
  top: 12px;
  left: 12px;
  border-radius: 999px;
  padding: 6px 12px;
  border: 1px solid rgba(148,163,184,0.5);
  background: rgba(15,23,42,0.9);
  color: #e5e7eb;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 20;
}
.back-btn:hover {
  border-color: #38bdf8;
}

/* контейнер */
.app-wrap {
  position: relative;
  z-index: 1;
  width: 100%;
  max-width: 520px;
  padding: 16px;
}

/* экраны */
.screen {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  text-align: center;
  padding: 20px 18px 22px;
  border-radius: 20px;
  background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
  border: 1px solid var(--border);
  box-shadow:
    0 22px 50px rgba(15,23,42,0.9),
    0 0 0 1px rgba(15,23,42,0.7);
}
.screen.active {
  display: flex;
}

/* заголовки */
.card-title {
  font-size: 18px;
  font-weight: 800;
  letter-spacing: .18em;
  text-transform: uppercase;
  background: linear-gradient(120deg, #e5e7eb, #f97316);
  -webkit-background-clip: text;
  color: transparent;
}
.sub {
  font-size: 12px;
  opacity: .75;
}

/* inputs */
.field-wrap {
  width: 100%;
  margin-top: 6px;
}
.label {
  font-size: 12px;
  text-align: left;
  opacity: .7;
  margin-bottom: 4px;
}
.input-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.input-row input {
  flex: 1;
  padding: 11px 12px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.6);
  background: rgba(15,23,42,0.95);
  color: #e5e7eb;
  font-size: 14px;
  outline: none;
}
.input-row input:focus {
  border-color: var(--accent1);
}
.indicator {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  border: 1px solid rgba(148,163,184,0.6);
  background: rgba(15,23,42,0.9);
}
.indicator.ok {
  border-color: var(--success);
  color: var(--success);
}
.indicator.err {
  border-color: var(--danger);
  color: var(--danger);
}
.msg {
  font-size: 11px;
  color: var(--danger);
  min-height: 14px;
  margin-top: 4px;
}

/* кнопки */
.btn {
  margin-top: 12px;
  padding: 11px 24px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  background: linear-gradient(110deg, #38bdf8, #6366f1);
  color: #020617;
  box-shadow: 0 12px 30px rgba(56,189,248,0.45);
  transition: transform .15s ease, box-shadow .15s ease, opacity .15s;
}
.btn:active {
  transform: translateY(1px) scale(.98);
  box-shadow: 0 8px 18px rgba(56,189,248,0.35);
}
.btn:disabled {
  opacity: .5;
  cursor: default;
  box-shadow: none;
}

/* connection */
.spinner {
  width: 48px;
  height: 48px;
  border-radius: 999px;
  border: 5px solid rgba(148,163,184,0.35);
  border-top-color: var(--accent1);
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* game info */
.mult-label {
  font-size: 12px;
  opacity: .65;
}
.best-value {
  margin-top: 4px;
  font-size: 24px;
  font-weight: 800;
  background: linear-gradient(110deg, var(--gold1), var(--gold2), var(--gold3));
  -webkit-background-clip: text;
  color: transparent;
  text-shadow: 0 0 18px rgba(234,179,8,0.55);
}
.attempts {
  font-size: 12px;
  margin-top: 4px;
  opacity: .75;
}

/* выбор количества шаров */
.balls-control {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 4px;
  font-size: 12px;
  opacity: .8;
}
.balls-btn {
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.7);
  background: rgba(15,23,42,0.9);
  padding: 4px 10px;
  font-size: 11px;
  cursor: pointer;
  color: #e5e7eb;
}
.balls-btn.active {
  border-color: #38bdf8;
  background: radial-gradient(circle at top, rgba(56,189,248,0.3), rgba(15,23,42,0.96));
}

/* plinko board */
.board-wrap {
  width: 100%;
  margin-top: 12px;
  border-radius: 16px;
  background: radial-gradient(circle at top, rgba(15,23,42,1), rgba(15,23,42,0.95));
  border: 1px solid rgba(30,64,175,0.7);
  box-shadow: 0 0 32px rgba(56,189,248,0.25);
  padding: 10px;
}
.board {
  position: relative;
  width: 100%;
  aspect-ratio: 3/4;
  border-radius: 12px;
  background: radial-gradient(circle at top, #020617, #020617 55%, #020617 100%);
  overflow: hidden;
  padding: 8px 6px 30px;
}
.peg-row {
  position: relative;
  display: flex;
  justify-content: center;
  gap: 9px;
  margin-top: 6px;
}
.dot {
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: rgba(209,213,219,0.95);
  box-shadow: 0 0 8px rgba(209,213,219,0.9);
}
.ball {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 999px;
  background: #f97316;
  box-shadow: 0 0 12px rgba(248,250,252,0.9);
  transform: translate(-50%, -50%);
}
.ball::after {
  content: "";
  position: absolute;
  inset: -4px;
  border-radius: inherit;
  border: 1px solid rgba(252,211,77,0.6);
}

/* нижние множители */
.mult-row {
  position: absolute;
  bottom: 4px;
  left: 6px;
  right: 6px;
  display: flex;
  justify-content: space-between;
  gap: 2px;
}
.mult-slot {
  flex: 1;
  text-align: center;
  font-size: 10px;
  padding: 2px 0;
  border-radius: 5px;
  background: rgba(15,23,42,0.95);
  border: 1px solid rgba(55,65,81,0.9);
  color: #e5e7eb;
}
.mult-slot.hot {
  background: radial-gradient(circle at top, rgba(249,115,22,0.25), rgba(15,23,42,0.96));
  border-color: #f97316;
  color: #f97316;
  box-shadow: 0 0 16px rgba(249,115,22,0.4);
}

.hint-bottom {
  font-size: 11px;
  opacity: .6;
}
</style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='../index.html'">← <span>MONEY TALKS</span></button>

<div class="app-wrap">

  <!-- PROMO -->
  <section id="promoScreen" class="screen active">
    <div class="card-title">PLINKO ACCESS</div>
    <div class="sub">Enter one-time promo code</div>

    <div class="field-wrap">
      <div class="label">Promo code</div>
      <div class="input-row">
        <input id="promoInput" placeholder="EXAMPLE88" maxlength="16" />
        <div id="promoIndicator" class="indicator">?</div>
      </div>
      <div id="promoMsg" class="msg"></div>
    </div>

    <button id="promoBtn" class="btn">Check promo</button>
  </section>

  <!-- LINK -->
  <section id="linkScreen" class="screen">
    <div class="card-title">CASINO LINK</div>
    <div class="sub">Paste Plinko game URL from your casino</div>

    <div class="field-wrap">
      <div class="label">Game link</div>
      <div class="input-row">
        <input id="linkInput" placeholder="https://example.com/game/plinko" />
        <div id="linkIndicator" class="indicator">?</div>
      </div>
      <div id="linkMsg" class="msg"></div>
    </div>

    <button id="linkBtn" class="btn">Connect</button>
  </section>

  <!-- CONNECTION -->
  <section id="connectScreen" class="screen">
    <div class="spinner"></div>
    <div class="sub" style="text-transform:uppercase; letter-spacing:.18em;">
      Connecting...
    </div>
  </section>

  <!-- GAME -->
  <section id="gameScreen" class="screen">
    <div class="card-title">PLINKO ANALYZER</div>
    <div class="sub">Simulated prediction. No real bets.</div>

    <div class="mult-label">Prediction result</div>
    <div id="bestValue" class="best-value">Best: x0.00</div>
    <div id="attemptsText" class="attempts">Attempts left: 7</div>

    <div class="balls-control">
      <span>Balls:</span>
      <button class="balls-btn active" data-balls="8">8</button>
      <button class="balls-btn" data-balls="16">16</button>
      <button class="balls-btn" data-balls="32">32</button>
    </div>

    <div class="board-wrap">
      <div class="board" id="board">
        <!-- пеги и шарики создаются в JS -->
        <div class="mult-row" id="multRow"></div>
      </div>
    </div>

    <button id="signalBtn" class="btn">Get signal</button>
    <div class="hint-bottom">Each promo code has 7 signals for Plinko.</div>
  </section>

</div>

<script>
const API_BASE = "/api";
const GAME_ID  = "plinko";

let attemptsLeft = 0;
let currentPromo = null;
let isAnimating  = false;
let ballCount    = 16; // дефолт

/* экраны */
const promoScreen   = document.getElementById("promoScreen");
const linkScreen    = document.getElementById("linkScreen");
const connectScreen = document.getElementById("connectScreen");
const gameScreen    = document.getElementById("gameScreen");

function showScreen(screen) {
  [promoScreen, linkScreen, connectScreen, gameScreen].forEach(s => s.classList.remove("active"));
  screen.classList.add("active");
}

/* -------- PROMO ---------- */
const promoInput     = document.getElementById("promoInput");
const promoIndicator = document.getElementById("promoIndicator");
const promoMsg       = document.getElementById("promoMsg");
const promoBtn       = document.getElementById("promoBtn");

promoInput.addEventListener("input", () => {
  promoIndicator.className = "indicator";
  promoIndicator.textContent = "?";
  promoMsg.textContent = "";
});

promoBtn.onclick = async () => {
  const code = promoInput.value.trim().toUpperCase();
  if (!code) {
    promoMsg.textContent = "Enter promo code";
    promoIndicator.className = "indicator err";
    promoIndicator.textContent = "✕";
    return;
  }

  promoBtn.disabled = true;
  promoMsg.textContent = "";
  promoIndicator.className = "indicator";
  promoIndicator.textContent = "…";

  try {
    const res = await fetch(`${API_BASE}/promo/check`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ game: GAME_ID, code })
    });
    const data = await res.json();

    if (!data.valid) {
      promoIndicator.className = "indicator err";
      promoIndicator.textContent = "✕";
      promoMsg.textContent = "Promo invalid or used up.";
      promoBtn.disabled = false;
      return;
    }

    attemptsLeft = data.attempts_left;
    currentPromo = code;

    promoIndicator.className = "indicator ok";
    promoIndicator.textContent = "✓";
    promoMsg.textContent = "";

    setTimeout(() => {
      showScreen(linkScreen);
    }, 250);

  } catch (e) {
    console.error(e);
    promoIndicator.className = "indicator err";
    promoIndicator.textContent = "!";
    promoMsg.textContent = "Connection error.";
  } finally {
    promoBtn.disabled = false;
  }
};

/* -------- LINK ---------- */
const linkInput     = document.getElementById("linkInput");
const linkIndicator = document.getElementById("linkIndicator");
const linkMsg       = document.getElementById("linkMsg");
const linkBtn       = document.getElementById("linkBtn");

linkInput.addEventListener("input", () => {
  linkIndicator.className = "indicator";
  linkIndicator.textContent = "?";
  linkMsg.textContent = "";
});

function isValidUrl(url) {
  return /^https?:\/\/[\w\-_.]+/i.test(url);
}

linkBtn.onclick = () => {
  const url = linkInput.value.trim();
  if (!isValidUrl(url)) {
    linkIndicator.className = "indicator err";
    linkIndicator.textContent = "✕";
    linkMsg.textContent = "Invalid URL.";
    return;
  }

  linkIndicator.className = "indicator ok";
  linkIndicator.textContent = "✓";
  linkMsg.textContent = "";

  showScreen(connectScreen);

  setTimeout(() => {
    updateAttemptsText();
    buildBoard();        // нарисовать пины + слоты
    showScreen(gameScreen);
  }, 2200 + Math.random() * 800);
};

/* -------- ВЫБОР КОЛ-ВА ШАРОВ ---------- */
const ballsButtons = document.querySelectorAll(".balls-btn");
ballsButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    ballsButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    ballCount = parseInt(btn.dataset.balls, 10) || 16;
  });
});

/* -------- BOARD + MULTIPLIERS ---------- */
const board      = document.getElementById("board");
const multRowEl  = document.getElementById("multRow");
const bestValueEl= document.getElementById("bestValue");
const attemptsEl = document.getElementById("attemptsText");
const signalBtn  = document.getElementById("signalBtn");

// более "реальные" множители, симметрично
const MULTIPLIERS = [
  0.20, 0.30, 0.40, 0.60,
  0.80, 1.00, 1.30, 2.00,
  4.20, 2.00, 1.30, 1.00,
  0.80, 0.60, 0.40, 0.30, 0.20
];
// рядов пинов = слотов - 1 (большая пирамида)
const ROWS = MULTIPLIERS.length - 1;

function updateAttemptsText() {
  attemptsEl.textContent = `Attempts left: ${attemptsLeft}`;
}

function buildBoard() {
  board.querySelectorAll(".peg-row").forEach(r => r.remove());

  // ряды пинов (большая пирамида)
  for (let r = 0; r < ROWS; r++) {
    const rowEl = document.createElement("div");
    rowEl.className = "peg-row";
    for (let c = 0; c <= r; c++) {
      const d = document.createElement("div");
      d.className = "dot";
      rowEl.appendChild(d);
    }
    board.insertBefore(rowEl, multRowEl);
  }

  // нижние множители
  multRowEl.innerHTML = "";
  let maxMult = Math.max(...MULTIPLIERS);

  MULTIPLIERS.forEach(m => {
    const slot = document.createElement("div");
    slot.className = "mult-slot";
    if (m === maxMult) slot.classList.add("hot");
    slot.textContent = "x" + m.toFixed(2);
    multRowEl.appendChild(slot);
  });

  bestValueEl.textContent = "Best: x0.00";
}

/* -------- СЕРВЕР: списание попытки ---------- */
async function requestUseFromServer() {
  if (!currentPromo) throw new Error("No promo");

  const res = await fetch(`${API_BASE}/game/use`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ game: GAME_ID, code: currentPromo })
  });

  if (!res.ok) {
    const data = await res.json().catch(() => ({}));
    if (data.detail === "limit_exceeded") {
      attemptsLeft = 0;
      updateAttemptsText();
      throw new Error("limit");
    }
    throw new Error("server");
  }

  const data = await res.json();
  attemptsLeft = data.remaining;
  return data;
}

/* -------- Plinko physics (анимация) ---------- */

function runPlinkoAnimation() {
  const rect = board.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;

  if (width < 40 || height < 40) return;

  // очистить старые шарики
  board.querySelectorAll(".ball").forEach(b => b.remove());

  const totalSlots = MULTIPLIERS.length;
  let bestMult = 0;

  // несколько шариков
  for (let b = 0; b < ballCount; b++) {
    setTimeout(() => {
      const ball = document.createElement("div");
      ball.className = "ball";
      board.appendChild(ball);

      const path = [];
      const rows = ROWS;
      const slots = totalSlots;

      // старт: центр
      let col = (slots - 1) / 2;

      for (let r = 0; r <= rows; r++) {
        const y = (r / (rows + 1)) * (height - 40) + 10;

        if (r > 0) {
          const dir = Math.random() < 0.5 ? -0.5 : 0.5;
          col += dir;
        }

        if (col < 0) col = 0;
        if (col > slots - 1) col = slots - 1;

        const x = ((col + 0.5) / slots) * width;
        path.push({ x, y });
      }

      // слот внизу
      let slotIndex = Math.round(col);
      if (slotIndex < 0) slotIndex = 0;
      if (slotIndex > slots - 1) slotIndex = slots - 1;
      const slotMult = MULTIPLIERS[slotIndex];
      bestMult = Math.max(bestMult, slotMult);

      const totalTime = 750; // быстрее падение
      let startTime = null;

      function animateBall(ts) {
        if (!startTime) startTime = ts;
        const progress = (ts - startTime) / totalTime;
        const clamped = Math.min(1, progress);
        const pos = clamped * (path.length - 1);
        const idx = Math.floor(pos);
        const frac = pos - idx;

        const p0 = path[idx];
        const p1 = path[Math.min(idx + 1, path.length - 1)];

        const x = p0.x + (p1.x - p0.x) * frac;
        const y = p0.y + (p1.y - p0.y) * frac;

        ball.style.left = x + "px";
        ball.style.top  = y + "px";

        if (clamped < 1) {
          requestAnimationFrame(animateBall);
        } else {
          bestValueEl.textContent = "Best: x" + bestMult.toFixed(2);
        }
      }

      requestAnimationFrame(animateBall);
    }, b * 90); // частые шары
  }

  const totalAnimMs = ballCount * 90 + 1100;
  setTimeout(() => {
    isAnimating = false;
    signalBtn.disabled = false;
  }, totalAnimMs);
}

/* -------- кнопка Get signal ---------- */
signalBtn.onclick = async () => {
  if (isAnimating) return;
  if (!currentPromo) {
    alert("Promo is required.");
    showScreen(promoScreen);
    return;
  }

  if (attemptsLeft <= 0) {
    alert("All attempts are used for this promo.");
    showScreen(promoScreen);
    return;
  }

  signalBtn.disabled = true;
  isAnimating = true;

  try {
    await requestUseFromServer();
  } catch (e) {
    if (e.message === "limit") {
      alert("All attempts are used for this promo.");
      showScreen(promoScreen);
    } else {
      alert("Server error. Try again later.");
    }
    signalBtn.disabled = false;
    isAnimating = false;
    return;
  }

  updateAttemptsText();
  runPlinkoAnimation();
};
</script>

</body>
</html>